name: Base Branch Checker

on:
  pull_request_target:
    # By default, a workflow only runs when a pull_request_target's activity type is opened, synchronize, or reopened. 
    branches:
      - master
jobs:
  base_branch_check:
    runs-on: ubuntu-latest
    name: Base Branch Check
    steps:
      - name: Get branch names
        id: branch-name
        uses: tj-actions/branch-names@v5.1
      - name: Determine if PR target is valid
        id: validTarget
        run: |
          if [[ "${{ steps.branch-name.outputs.head_ref_branch  == 'development' }}" = "false" && "${{ startsWith(steps.branch-name.outputs.head_ref_branch, 'release/') }}" = "false" ]]; then
            value=true
          else
            value=false
          fi
          echo ::set-output name=value::${value}
      - name: Comment on invalid target
        if: steps.validTarget.outputs.value == 'false'
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: >
            Thank you very much for your contribution. An automated check has shown that you have opened your Pull Request to the `master` branch. However, our project uses the `master` branch only for tested code.
            
            **Please submit your Pull Requests to the `development` branch**. In most cases, you don't have to create a new pull request but can simply [change the base branch](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/changing-the-base-branch-of-a-pull-request)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Add label on invalid target
        if: steps.validTarget.outputs.value == 'false'
        uses: buildsville/add-remove-label@v1
        with:
          token: ${{secrets.GITHUB_TOKEN}}
          label: "Invalid target"
          type: add
      - name: Remove label on valid target # may have been added before
        uses: buildsville/add-remove-label@v1
        if: steps.validTarget.outputs.value == 'true'
        with:
          token: ${{secrets.GITHUB_TOKEN}}
          label: "Invalid target"
          type: remove
